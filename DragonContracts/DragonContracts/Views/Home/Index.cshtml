@{
    ViewBag.Title = "Home";
}
@section Scripts {
    @Scripts.Render("~/bundles/knockout")

    <script type="text/javascript">
        function ContractsViewModel() {
            var self = this;
            self.loaded = ko.observable(false);
            self.contracts = ko.observableArray([]);
            self.emptyContractJs = null;
            self.newContract = ko.observable();

            self.createContractFromForm = function(formElement) {
                // If valid, post the serialized form data to the web api

                $.validator.unobtrusive.parse($(formElement));

                var val = $(formElement).validate();
                var isValid = val.form();
                if (isValid) {
                    var newContractJs = ko.mapping.toJS(self.newContract);

                    var json = ko.mapping.toJSON(self.newContract);
                    alert(json);

                    //$.post("/api/contract", newContractJs, "json")
                    //    .done(function(status) {
                    //        alert(status);
                    //        self.contracts.push(newContractJs);
                    //    });

                    self.newContract(ko.mapping.fromJS(self.emptyContractJs));
                    var d = new Date();
                    var now = d.toLocaleString("cs");
                    
                    self.newContract().SignedOn(now);
            }
        }

        ;

        self.removeContact = function(contact) {
            // First remove from the server, then from the UI
            $.ajax({ type: "DELETE", url: contact.Self })
                .done(function() { self.contracts.remove(contact); });
        };

        // Load the initial state
        $.getJSON("/api/contract")
            .done(function(data) {
                self.emptyContractJs = data;
                self.newContract(ko.mapping.fromJS(data));

                $.datepicker.setDefaults($.datepicker.regional['cs']);
                $("[datepicker='datepicker']").datepicker();
            });

        $.getJSON("/api/contracts", self.contracts)
            .done(function() {
                self.loaded(true);

                //test to rewrite ids for use with Html.Partial
                //$("#firstParty").find("[id]").each(function (index, element) {
                //    element.parent()
                //});
            });
        }
        
        jQuery.validator.methods["date"] = function(value, element) {
            try { jQuery.datepicker.parseDate( 'd.m.yy', value); return true; }
            catch(e){return false;}
            };
        
        ko.applyBindings(new ContractsViewModel());

        //$(function() {
        //    $.datepicker.setDefaults($.datepicker.regional['cs']);
        //    $("[datepicker='datepicker']").datepicker();
        //});
        

    </script>
}

<div id="body">
    <section class="featured">
        <div class="content-wrapper">
            <div>
                <button>Všechny typy</button>
                <button>Smlouvy o dílo</button>
                <button>Mandátní smlouvy</button>
                <button>Kupní smlouvy</button>
                <button>Nájemní smlouvy</button>
                <button>Ostatní smlouvy</button>
            </div>
        </div>
    </section>
    <section class="content-wrapper main-content clear-fix">
        <div class="float-left">
            <img id="loader" src="images/ajax-loader.gif" data-bind="visible: !loaded()" />

            <ul id="contracts" data-bind="visible: loaded, foreach: contracts">
                <li>
                    <h3 data-bind="text: Subject" class="ui-widget-header"></h3>
                    <div><span data-bind="text: Price"></span></div>
                    <div><span data-bind="text: SignedOn"></span></div>
                    <div data-bind="with: FirstParty" >
                        <label>Objednatel</label>
                        @Html.Partial("Partial/ContactView")
                    </div>
                    <div data-bind="with: SecondParty">
                        <label>Zhotovitel</label>
                        @Html.Partial("Partial/ContactView")
                    </div>
                </li>
            </ul>
        </div>
        <div class="float-right" data-bind="with: newContract">
            @Html.Partial("AddContract")
        </div>
    </section>

</div>
